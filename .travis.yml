sudo: required

branches:
  only:
    - master

services:
- docker

arch:
# repos:
# - papyros=http://dash.papyros.io/repos/$repo/$arch
  packages:
  # arch/aur packages
# - python
# - perl
  script:
  # arch pkg naming scheme: <$pkgname>-<?$epoch+':'><$pkgver>-<$arch>.pkg.tar.xz
  # commit message subject: <$pkgname> <$pkgver>
  # notice: you can't use travis env variables inside docker env ($TRAVIS_COMMIT_MESSAGE)
  - |
    while
      commit_message=$(git log --pretty="%s" --skip ${i:-0} -n 1)
      grep -qv "skip ci" <<<"$commit_message"
    do
      read pkgname pkgver <<<"$commit_message"
      echo $pkgname $pkgver
      repo-add bartus.db.tar -R $pkgname*$pkgver*.pkg.tar.xz
      ((i++))
    done
    rm bartus.db bartus.files
    cp bartus.db.tar bartus.db
    cp bartus.files.tar bartus.files

script:
- "curl -s https://raw.githubusercontent.com/mikkeloscar/arch-travis/master/arch-travis.sh | bash"

deploy:
  provider: script
  script: bash .travis_deploy.sh
  on:
    branch: master
  skip_cleanup: true
